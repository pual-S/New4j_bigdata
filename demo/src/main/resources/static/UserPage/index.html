<!DOCTYPE html>
<html lang="en" >

<head>
  <meta charset="UTF-8">
  <title>医疗平台页面</title>
	<link rel='stylesheet' href='../css/all.min.css'>
  <link rel="stylesheet" href="../css/Userpagestyle.css">
	<link rel="shortcut icon" href="../img/logo.jpg" type="text/plain">
	<script src="../js/jquery.min.js"></script>
	<script src="../js/sockjs.min.js"></script>
</head>

<body>
<script>
	var socket,userchatname="***";
	var usermsg;
	if ('WebSocket' in window) {
		socket = new WebSocket('wss://www.shicf.cloud//chatting/');
//		socket = new WebSocket('ws://localhost:9090/chatting/');
		socket.onopen = function() {

			var code = $("#usertext");

			code.attr("disabled", "disabled");
			code.val("系统正在启动......");
			code.attr("class","inputText");
			code.attr("style","font-size: 20px");

			console.log("已经连通了websocket"+userchatname);
		};

		socket.onmessage = function(event) {
			var message = event.data;
			//拼接字符串到前端显示
			var test= '';
			var system_str;
			if(message[0]==="`") {
				//药物拼接
				for (let i = 0; i < message.length; i++) {
					if (message[i] !== "`") {
						test += message[i]
					} else {
						test += '<br>'
					}
				}
				system_str = '<li class="message left" id="username">';
				system_str += '<img class="logo" src="../img/docter.jpg" alt="医生">';
				system_str += '<p style="color: cadetblue">推荐看一下: <a href="https://www.yaofangwang.com/yao/" target="_blank" style="color: sandybrown" class="message"> 药品购买  </a></p>';
				system_str += '</li>';
			}else if(message[0]==="&"){
				//医生拼接
				for (let i = 0; i < message.length; i++) {
					if (message[i] !== "&") {
						test += message[i]
					} else {
						test += '<br>'
					}
				}
				system_str = '<li class="message left" id="username">';
				system_str += '<img class="logo" src="../img/docter.jpg" alt="医生">';
				system_str +='<p style="color: cadetblue">利用网络资源进行: <a href="../DoctorPage/index.html" target="_blank" style="color: sandybrown" class="message">  医生在线问诊  </a></p>';
				system_str += '</li>';
			}else if(message[0]==="*"){

				for (let i = 1; i < message.length; i++) {
						test += message[i]
				}
				//时间响应
				document.getElementById("Response").value="本次响应时间:"+test+"ms";
			}else {
				//正常回答拼接
				for (let i = 0; i < message.length; i++) {
					if (message[i] !== "@") {
						test += message[i]
					} else {
						test += '<br>'
					}
				}
				system_str = '<li class="message left" id="username">';
				system_str += '<img class="logo" src="../img/docter.jpg" alt="医生">';
				system_str += '<p style="color: cadetblue">'+test+'</p>';
				system_str += '</li>';
			}

			console.log("Received message: " + message);
			document.getElementById("usertext").value="";
			$("#chatuser").append(system_str);

			var code = $("#usertext");

			/*设置为输入状态*/
			code.attr("disabled", false).val("");

			console.log("系统消息消息已经发出")
		};

		socket.onclose = function() {
			console.log("WebSocket is closed now.");
			window.alert("系统已经关闭.出现这种情况大概率是云端数据库连接不稳定.重新刷新页面即可")
		};

		socket.onerror = function (){
			console.log("WebSocket is error now.");
			window.alert("系统发生错误.网络波动太大了")
		}

	}else {
		window.alert("浏览器不支持websocket")
	}

	function sendMessage() {
		//封装成object集合
		let message = new Object();
		message.name=userchatname;
		message.message=usermsg;
		message.sendTime=getDaten();
		console.log(message)
		//发送消息的方法
		socket.send(JSON.stringify(message));
	}

	function getDaten() {
		var fTime = new Date();
		var year=fTime.getFullYear().toString();
		var month=fTime.getMonth().toString();
		var date=fTime.getDate().toString()
		var hours=fTime.getHours().toString()
		var minutes=fTime.getMinutes().toString()
		var secondes=fTime.getSeconds().toString()
		month=parseFloat(month)+1;
		return year+"年"+month+"月"+date+"日"+hours+"时"+minutes+"分"+secondes+"秒";
	}

	//当输入回车键时，获取输入框内容，打印到前台并且进行配置
	$(document).keyup(function (event) {
		if (document.getElementById("usertext").value.length === 0) {
			console.log("输入为空!")
		}else{
			//获取enter回车键发送消息
			if (event.keyCode === 13) {
				var test=$("#usertext").val();
				var li_str='<li class="message right" id="username">';
				li_str += '<img class="logo" src="../img/Patient.jpg" alt="患者">';
				li_str += '<p style="color: blue">'+test+'</p>'
				li_str += '</li>';
				usermsg=test;

				$("#chatuser").append(li_str);

				var code = $("#usertext");
				code.attr("disabled", "disabled");
				code.val("机器人正在应答请耐心等待......");
				code.attr("class","inputText");
				code.attr("style","font-size: 20px");

				//发送信息到后端
				sendMessage()
			}
		}
	})

	function UserRead(){
		window.alert("使用规则:我们主要基于外科病例进行机器问答.会给用户智能推荐需要吃的药物和专家问诊功能.\n\n" +
				"不足:如果出现了问答不匹配的情况下.说明我们的词库不是很完美.请见谅.\n\n" +
				"我们这个项目只是做了初步的结果判断.距离真正的AL机器人还有不小的距离.如果要想做到回答完美准确." +
				"需要进行医学模型的构建和神经网络的构建.我们只是用了sparkMLlib库做了朴素贝叶斯初步机器学习的做了初步处理." +
				"然后将结构和Neo4j知识图谱进行查询最优的解." +
				"当需要联系上下文的时候.我们做出的判断是将患者上一步的主语进行了二次机器学习.\n\n" +
				"我们具有4w+知识实体的真实医生患者交流数据的模型.2w+的药品推荐模型.规模30w+的实体关系的知识图谱.\n\n"+
				"主要支持一些内科,呼吸内科,急诊科,等等.比如:肺炎杆菌肺炎.肺大疱.肺念珠菌病\n\n"+
				"问句支持:症状.病因.预防措施.治疗方法.药物治疗.检查方式.等等")
	}

	setInterval(function() {
		document.querySelector('.time').innerHTML = getDaten();
	}, 1000)
</script>
  <h1 style="color: #3c97bf">人工智能</h1>
<div class="time" style="color: blue"></div>
<br>
	<input id="Response" value="本次响应时间:..." class="message" style="background: #3c97bf" readonly>
<br>
<div class="chat-container">
	<ul class="chat" id="chatuser">
		<li class="message left" id="doctername">
			<img class="logo" src="../img/docter.jpg" alt="医生">
			<p style="color: #9297e0">您好,我是您的医疗机器人"小苹果",很高兴为您服务</p>
			<p style="color: #9297e0">在使用之前我希望您可以看一下  <a href="#" style="color: blue" onclick="UserRead()" class="message">  阅读手册</a></p>
		</li>
	</ul>
</div>
<p>
  	<input id="usertext" type="text" class="inputText" placeholder="请输入内容..." style="font-size: 20px"/>
</body>

</html>
